name: PR ë¹Œë“œ í…ŒìŠ¤íŠ¸

on:
  pull_request:
    branches: [ develop ]
    types: [ opened, synchronize, reopened ]
  release:
    types: [ published ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸

    steps:
      # GitHub repository ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # Java 17 ì„¤ì •
      - name: Java 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # Gradle ê¶Œí•œ ë¶€ì—¬
      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      # Gradle ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew clean test
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      # í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë„ ê²°ê³¼ í™•ì¸ ê°€ëŠ¥)
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/reports/tests/test/

      # ë¹Œë“œ ì‹¤í–‰
      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: ./gradlew bootJar
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      # JAR íŒŒì¼ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
      - name: JAR íŒŒì¼ ê²€ì¦
        run: |
          echo "ë¹Œë“œëœ JAR íŒŒì¼ í™•ì¸ ì¤‘..."
          ls -la build/libs/
          
          # JAR íŒŒì¼ì´ ì œëŒ€ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if [ -f build/libs/*.jar ]; then
            echo "âœ… JAR íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"
          else
            echo "âŒ JAR íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      # ë¹Œë“œ ì„±ê³µ ì•Œë¦¼
      - name: ë¹Œë“œ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "âœ… ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ” PR ë³€ê²½ì‚¬í•­ì´ ì•ˆì „í•˜ê²Œ ë¹Œë“œë©ë‹ˆë‹¤."

      # ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
      - name: ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ”§ PRì„ ë¨¸ì§€í•˜ê¸° ì „ì— ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."